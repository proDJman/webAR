<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mamont AR</title>

  <script src="./libs/aframe.min.js"></script>
  <script src="./libs/aframe-extras.min.js"></script>
  <script src="./libs/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; }

    /* Твой текст "Наведите на метку" */
    #scanning-overlay {
      position: absolute;
      bottom: 20px; left: 0; right: 0;
      text-align: center;
      color: white;
      z-index: 10;
      font-family: sans-serif;
      text-shadow: 0 0 5px black;
      display: none; /* покажем после разрешения камеры */
    }

    /* Твоя картинка-оверлей */
    #guide-overlay {
      position: absolute;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      opacity: 0.5;
      z-index: 5;
      pointer-events: none;
      display: none; /* покажем после разрешения камеры */
    }

    /* Стартовый экран */
    #start-screen {
      position: absolute;
      inset: 0;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      background: rgba(0,0,0,0.92);
      padding: 24px;
    }

    #start-title { font-size: 18px; opacity: 0.95; }
    #start-subtitle { font-size: 14px; opacity: 0.8; max-width: 520px; line-height: 1.35; }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    /* простой спиннер */
    #spinner {
      width: 34px;
      height: 34px;
      border: 3px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.95);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #status { font-size: 14px; opacity: 0.85; min-height: 18px; }
  </style>

  <script>
    AFRAME.registerComponent('marker-handler', {
      init: function () {
        const guide = document.querySelector('#guide-overlay');
        const scanning = document.querySelector('#scanning-overlay');

        this.el.addEventListener('targetFound', () => {
          console.log("targetFound");
          guide.style.display = 'none';
          scanning.style.display = 'none';
        });

        this.el.addEventListener('targetLost', () => {
          console.log("targetLost");
          guide.style.display = 'block';
          scanning.style.display = 'block';
        });
      }
    });
  </script>
</head>

<body>
  <!-- СТАРТОВЫЙ ЭКРАН (пока нет разрешения камеры) -->
  <div id="start-screen">
    <div id="start-title">Загрузка…</div>
    <div id="start-subtitle">
      Нажмите кнопку ниже, чтобы разрешить доступ к камере.
      После этого появится подсказка-оверлей для наведения на экспонат.
    </div>
    <div id="spinner"></div>
    <div id="status"></div>
    <button id="start-btn" class="btn">Включить камеру</button>
  </div>

  <!-- ТВОИ ОВЕРЛЕИ (покажем только после старта AR) -->
  <div id="scanning-overlay">Наведите на метку</div>
  <img id="guide-overlay" src="./mamont.jpg" />

  <a-scene
    mindar-image="
      imageTargetSrc: ./mamont.mind;
      autoStart: false;
      uiLoading: no;
      uiScanning: no;
    "
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true;"
  >
    <a-assets>
      <a-asset-item id="model" src="./mamont2.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" marker-handler>
      <a-gltf-model
        src="#model"
        position="0 0 0"
        scale="0.7 0.7 0.7"
        rotation="0 -90 0"
        animation-mixer="clip: Gesture; loop: repeat"
      ></a-gltf-model>
    </a-entity>
  </a-scene>

  <script>
    window.addEventListener("error", (e) => console.log("window.error:", e.message));
    window.addEventListener("unhandledrejection", (e) => console.log("promise:", e.reason));

    document.addEventListener("DOMContentLoaded", () => {
      const scene = document.querySelector("a-scene");

      const startScreen = document.querySelector("#start-screen");
      const startBtn = document.querySelector("#start-btn");
      const spinner = document.querySelector("#spinner");
      const status = document.querySelector("#status");

      const guide = document.querySelector("#guide-overlay");
      const scanning = document.querySelector("#scanning-overlay");

      const setStatus = (t) => { status.textContent = t || ""; };

      // Когда AR реально готов (камера уже выдана и трекинг поднялся)
      scene.addEventListener("arReady", () => {
        console.log("MindAR ready");
        startScreen.style.display = "none";
        guide.style.display = "block";
        scanning.style.display = "block";
      });

      scene.addEventListener("arError", (e) => {
        console.log("MindAR error", e.detail);
        spinner.style.display = "none";
        startBtn.disabled = false;
        setStatus("Не удалось запустить камеру/AR. Проверьте разрешения и HTTPS.");
      });

Понял. Это типичная проблема iOS/Safari: ты делаешь getUserMedia(), сразу останавливаешь треки, и тут же MindAR пытается снова открыть камеру — а iOS ещё “не отпустил” девайс камеры (release не мгновенный). В итоге первый запуск висит “нет доступа / ждём”, а через 30–60 сек камера реально освобождается — и со 2-го нажатия MindAR стартует.

В твоём текущем mamont.html как раз так и сделано: getUserMedia → stop tracks → mindar.start() без паузы/ретрая. 

mamont

Что сделать (работающее решение)

После stop() дать паузу (обычно 600–1200мс на iOS).

Сделать авто-retry mindar.start() 2–3 раза (без второго тапа).

Поставить таймаут, чтобы не “ждать минуту молча”.

Вот готовая замена твоего обработчика кнопки (вставь вместо текущего startBtn.addEventListener("click", ...)) 

mamont

:

startBtn.addEventListener("click", async () => {
  const mindar = scene.systems["mindar-image-system"];
  if (!mindar) {
    setStatus("MindAR не найден (mindar-image-system).");
    return;
  }

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const lockUi = (locked, text) => {
    startBtn.disabled = locked;
    spinner.style.display = locked ? "block" : "none";
    setStatus(text || "");
  };

  // ждём arReady не бесконечно
  const waitForArReady = (timeoutMs = 8000) => new Promise((resolve, reject) => {
    let done = false;
    const ok = () => {
      if (done) return;
      done = true;
      cleanup();
      resolve(true);
    };
    const fail = () => {
      if (done) return;
      done = true;
      cleanup();
      reject(new Error("arReady timeout"));
    };
    const cleanup = () => {
      scene.removeEventListener("arReady", ok);
      clearTimeout(t);
    };
    scene.addEventListener("arReady", ok, { once: true });
    const t = setTimeout(fail, timeoutMs);
  });

  try {
    lockUi(true, "Запрашиваем доступ к камере…");

    // 1) Нативный запрос разрешения
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    // 2) ВАЖНО: iOS не сразу освобождает камеру после stop().
    stream.getTracks().forEach(t => t.stop());

    // Даем iOS реально “отпустить” камеру
    lockUi(true, "Подготовка камеры…");
    await sleep(900); // можно 600..1200, 900 обычно норм

    // 3) Авто-повтор запуска MindAR (без второго тапа)
    lockUi(true, "Инициализация AR…");

    let lastErr = null;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        await mindar.start();
        await waitForArReady(9000); // дождаться готовности
        lastErr = null;
        break;
      } catch (e) {
        lastErr = e;
        console.log("mindar.start attempt", attempt, "failed:", e);
        // ещё чуть подождать и повторить
        await sleep(700 + attempt * 300);
      }
    }

    if (lastErr) throw lastErr;

    // дальше arReady сам скроет стартовый экран (как у тебя)
  } catch (err) {
    console.log("start error:", err);
    lockUi(false, "Не удалось запустить камеру/AR. Проверьте: HTTPS и разрешение камеры.");
  }
});
    });
  </script>
</body>
</html>
