<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mamont AR</title>

  <script src="./libs/aframe.min.js"></script>
  <script src="./libs/aframe-extras.min.js"></script>
  <script src="./libs/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; }

    #scanning-overlay {
      position: absolute;
      bottom: 20px; left: 0; right: 0;
      text-align: center;
      color: white;
      z-index: 10;
      font-family: sans-serif;
      text-shadow: 0 0 5px black;
      display: none;
    }

    #guide-overlay {
      position: absolute;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      opacity: 0.5;
      z-index: 5;
      pointer-events: none;
      display: none;
    }

    /* Экран загрузки */
    #start-screen {
      position: absolute;
      inset: 0;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #000; /* Чистый черный фон для прелоадера */
      color: #fff;
      font-family: sans-serif;
      transition: opacity 0.5s ease;
    }

    /* Спиннер */
    #spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Кнопка и статус (скрыты по умолчанию, покажем только при ошибке) */
    #start-btn, #status { display: none; margin-top: 20px; }
    
    #status { 
      font-size: 14px; 
      color: #ff4444; 
      padding: 0 20px; 
      text-align: center; 
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: #fff;
      color: #000;
      cursor: pointer;
    }
  </style>

  <script>
    // Регистрируем компоненты (оставляем без изменений)
    AFRAME.registerComponent('marker-handler', {
      init: function () {
        const guide = document.querySelector('#guide-overlay');
        const scanning = document.querySelector('#scanning-overlay');
        this.el.addEventListener('targetFound', () => {
          guide.style.display = 'none';
          scanning.style.display = 'none';
        });
        this.el.addEventListener('targetLost', () => {
          guide.style.display = 'block';
          scanning.style.display = 'block';
        });
      }
    });

    AFRAME.registerComponent('pose-smoothing', {
      schema: {
        posAlpha: { type: 'number', default: 0.15 },
        rotAlpha: { type: 'number', default: 0.12 }
      },
      init() {
        this.tmpPos = new THREE.Vector3();
        this.tmpQuat = new THREE.Quaternion();
        this.curPos = new THREE.Vector3();
        this.curQuat = new THREE.Quaternion();
        this.inited = false;
      },
      tick() {
        const o = this.el.object3D;
        o.getWorldPosition(this.tmpPos);
        o.getWorldQuaternion(this.tmpQuat);
        if (!this.inited) {
          this.curPos.copy(this.tmpPos);
          this.curQuat.copy(this.tmpQuat);
          this.inited = true;
        } else {
          this.curPos.lerp(this.tmpPos, this.data.posAlpha);
          this.curQuat.slerp(this.tmpQuat, this.data.rotAlpha);
        }
        if (o.parent) {
          const parentInv = new THREE.Matrix4().copy(o.parent.matrixWorld).invert();
          const m = new THREE.Matrix4().compose(this.curPos, this.curQuat, new THREE.Vector3(1,1,1));
          m.premultiply(parentInv);
          m.decompose(o.position, o.quaternion, o.scale);
          o.matrixWorldNeedsUpdate = true;
        }
      }
    });
  </script>
</head>

<body>
  <div id="start-screen">
    <div id="spinner"></div>
    <div id="status"></div>
    <button id="start-btn" class="btn">Разрешить камеру</button>
  </div>

  <div id="scanning-overlay">Наведите на метку</div>
  <img id="guide-overlay" src="./mamont.jpg" />

  <a-scene
    mindar-image="imageTargetSrc: ./mamont.mind; autoStart: false; uiLoading: no; uiScanning: no;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true;"
  >
    <a-assets>
      <a-asset-item id="model" src="./mamont2.glb"></a-asset-item>
    </a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0" marker-handler pose-smoothing="posAlpha: 0.12; rotAlpha: 0.10">
      <a-gltf-model src="#model" position="0 0 0" scale="0.7 0.7 0.7" rotation="0 -90 0" animation-mixer="clip: Gesture; loop: repeat"></a-gltf-model>
    </a-entity>
  </a-scene>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const scene = document.querySelector("a-scene");
      const startScreen = document.querySelector("#start-screen");
      const startBtn = document.querySelector("#start-btn");
      const status = document.querySelector("#status");
      const spinner = document.querySelector("#spinner");
      const guide = document.querySelector("#guide-overlay");
      const scanning = document.querySelector("#scanning-overlay");

      const startAR = async () => {
        const mindar = scene.systems["mindar-image-system"];
        try {
          // Запрашиваем доступ
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          stream.getTracks().forEach(t => t.stop());
          
          await mindar.start();
        } catch (err) {
          console.error(err);
          // Если ошибка (отказ или блок автозапуска), показываем кнопку и текст
          spinner.style.display = "none";
          startBtn.style.display = "block";
          status.style.display = "block";
          status.textContent = "Для работы AR нужен доступ к камере.";
        }
      };

      scene.addEventListener("arReady", () => {
        startScreen.style.opacity = "0";
        setTimeout(() => {
          startScreen.style.display = "none";
          guide.style.display = "block";
          scanning.style.display = "block";
        }, 500);
      });

      // Пытаемся запустить сразу при загрузке
      startAR();

      // Если автозапуск не сработал, кнопка вызовет ту же функцию
      startBtn.addEventListener("click", () => {
        startBtn.style.display = "none";
        status.style.display = "none";
        spinner.style.display = "block";
        startAR();
      });
    });
  </script>
</body>
</html>