<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mamont AR</title>

  <script src="./libs/aframe.min.js"></script>
  <script src="./libs/aframe-extras.min.js"></script>
  <script src="./libs/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; }

    /* Твой текст "Наведите на метку" */
    #scanning-overlay {
      position: absolute;
      bottom: 20px; left: 0; right: 0;
      text-align: center;
      color: white;
      z-index: 10;
      font-family: sans-serif;
      text-shadow: 0 0 5px black;
      display: none; /* покажем после разрешения камеры */
    }

    /* Твоя картинка-оверлей */
    #guide-overlay {
      position: absolute;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      opacity: 0.5;
      z-index: 5;
      pointer-events: none;
      display: none; /* покажем после разрешения камеры */
    }

    /* Стартовый экран */
    #start-screen {
      position: absolute;
      inset: 0;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      background: rgba(0,0,0,0.92);
      padding: 24px;
    }

    #start-title { font-size: 18px; opacity: 0.95; }
    #start-subtitle { font-size: 14px; opacity: 0.8; max-width: 520px; line-height: 1.35; }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    /* простой спиннер */
    #spinner {
      width: 34px;
      height: 34px;
      border: 3px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.95);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #status { font-size: 14px; opacity: 0.85; min-height: 18px; }
  </style>

  <script>
    AFRAME.registerComponent('marker-handler', {
      init: function () {
        const guide = document.querySelector('#guide-overlay');
        const scanning = document.querySelector('#scanning-overlay');

        this.el.addEventListener('targetFound', () => {
          console.log("targetFound");
          guide.style.display = 'none';
          scanning.style.display = 'none';
        });

        this.el.addEventListener('targetLost', () => {
          console.log("targetLost");
          guide.style.display = 'block';
          scanning.style.display = 'block';
        });
      }
    });
	AFRAME.registerComponent('pose-smoothing', {
  schema: {
    posAlpha: { type: 'number', default: 0.15 }, // 0..1 (меньше = сильнее сглаживание)
    rotAlpha: { type: 'number', default: 0.12 }
  },
  init() {
    this.tmpPos = new THREE.Vector3();
    this.tmpQuat = new THREE.Quaternion();
    this.curPos = new THREE.Vector3();
    this.curQuat = new THREE.Quaternion();
    this.inited = false;
  },
  tick() {
    // Берём "сырую" позу из object3D (её MindAR обновляет сам)
    const o = this.el.object3D;

    o.getWorldPosition(this.tmpPos);
    o.getWorldQuaternion(this.tmpQuat);

    if (!this.inited) {
      this.curPos.copy(this.tmpPos);
      this.curQuat.copy(this.tmpQuat);
      this.inited = true;
    } else {
      this.curPos.lerp(this.tmpPos, this.data.posAlpha);
      this.curQuat.slerp(this.tmpQuat, this.data.rotAlpha);
    }

    // Применяем сглаженную позу обратно (локально)
    // Важно: работаем с local transform, поэтому переводим в local координаты родителя
    if (o.parent) {
      const parentInv = new THREE.Matrix4().copy(o.parent.matrixWorld).invert();

      const m = new THREE.Matrix4().compose(this.curPos, this.curQuat, new THREE.Vector3(1,1,1));
      m.premultiply(parentInv);

      m.decompose(o.position, o.quaternion, o.scale);
      o.matrixWorldNeedsUpdate = true;
    }
  }
});

  </script>
</head>

<body>
  <!-- СТАРТОВЫЙ ЭКРАН (пока нет разрешения камеры) -->
#spinner { display: block; }
#status { font-size: 12px; opacity: 0.6; min-height: 14px; }

  <!-- ТВОИ ОВЕРЛЕИ (покажем только после старта AR) -->
  <div id="scanning-overlay">Наведите на метку</div>
  <img id="guide-overlay" src="./mamont.jpg" />

  <a-scene
    mindar-image="
      imageTargetSrc: ./mamont.mind;
      autoStart: false;
      uiLoading: no;
      uiScanning: no;
    "
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true;"
  >
    <a-assets>
      <a-asset-item id="model" src="./mamont2.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" marker-handler pose-smoothing="posAlpha: 0.12; rotAlpha: 0.10">
      <a-gltf-model
        src="#model"
        position="0 0 0"
        scale="0.7 0.7 0.7"
        rotation="0 -90 0"
        animation-mixer="clip: Gesture; loop: repeat"
      ></a-gltf-model>
    </a-entity>
  </a-scene>

  <script>
    window.addEventListener("error", (e) => console.log("window.error:", e.message));
    window.addEventListener("unhandledrejection", (e) => console.log("promise:", e.reason));

document.addEventListener("DOMContentLoaded", () => {
  const scene = document.querySelector("a-scene");

  const startScreen = document.querySelector("#start-screen");
  const spinner = document.querySelector("#spinner");
  const status = document.querySelector("#status");

  const guide = document.querySelector("#guide-overlay");
  const scanning = document.querySelector("#scanning-overlay");

  const setStatus = (t) => { status.textContent = t || ""; };
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  let started = false;

  // Когда AR реально готов (камера уже выдана и трекинг поднялся)
  scene.addEventListener("arReady", () => {
    console.log("MindAR ready");
    startScreen.style.display = "none";
    guide.style.display = "block";
    scanning.style.display = "block";
  });

  scene.addEventListener("arError", (e) => {
    console.log("MindAR error", e.detail);
    // Без длинных надписей — только короткая подсказка
    setStatus("Тапните по экрану, чтобы включить камеру");
    started = false;
  });

  async function startAR() {
    if (started) return;
    started = true;

    try {
      setStatus("");              // без текста
      spinner.style.display = "block";

      // ВАЖНО: нативный prompt (только в user gesture)
      setStatus(""); // если хочешь — можно "Камера…" (но ты просил без текста)
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      stream.getTracks().forEach(t => t.stop());

      // iOS: дать время “отпустить” камеру перед MindAR
      await sleep(900);

      const mindar = scene.systems["mindar-image-system"];
      if (!mindar) throw new Error("mindar-image-system not found");

      // Пара попыток старта, чтобы не требовать “второго тапа”
      let ok = false;
      for (let i = 0; i < 3; i++) {
        try {
          await mindar.start();
          ok = true;
          break;
        } catch (e) {
          console.log("mindar.start retry", i + 1, e);
          await sleep(700 + i * 300);
        }
      }
      if (!ok) throw new Error("mindar.start failed");

      // дальше ждём arReady (он сам скроет прелоадер)
    } catch (err) {
      console.log("start error:", err);
      started = false;
      // коротко, без простыней
      setStatus("Тапните по экрану, чтобы включить камеру");
    }
  }

  // “Жест без кнопки”: первый тап/клик в любом месте
  const onFirstGesture = () => startAR();
  window.addEventListener("touchend", onFirstGesture, { passive: true });
  window.addEventListener("click", onFirstGesture);

  // Можно попробовать автозапускнуть, но на iOS это чаще всего не откроет prompt —
  // оставляем, чтобы на Android/desktop могло стартануть сразу.
  startAR();
});
    });
  </script>
</body>
</html>
