<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mamont AR</title>

  <script src="./libs/aframe.min.js"></script>
  <script src="./libs/aframe-extras.min.js"></script>
  <script src="./libs/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: #000; }

    /* Твой текст "Наведите на метку" */
    #scanning-overlay {
      position: absolute;
      bottom: 20px; left: 0; right: 0;
      text-align: center;
      color: white;
      z-index: 10;
      font-family: sans-serif;
      text-shadow: 0 0 5px black;
      display: none; /* покажем после разрешения камеры */
    }

    /* Твоя картинка-оверлей */
    #guide-overlay {
      position: absolute;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      opacity: 0.5;
      z-index: 5;
      pointer-events: none;
      display: none; /* покажем после разрешения камеры */
    }

    /* Стартовый экран */
    #start-screen {
      position: absolute;
      inset: 0;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      background: rgba(0,0,0,0.92);
      padding: 24px;
    }

    #start-title { font-size: 18px; opacity: 0.95; }
    #start-subtitle { font-size: 14px; opacity: 0.8; max-width: 520px; line-height: 1.35; }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    /* простой спиннер */
    #spinner {
      width: 34px;
      height: 34px;
      border: 3px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.95);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #status { font-size: 14px; opacity: 0.85; min-height: 18px; }
  </style>

  <script>
    AFRAME.registerComponent('marker-handler', {
      init: function () {
        const guide = document.querySelector('#guide-overlay');
        const scanning = document.querySelector('#scanning-overlay');

        this.el.addEventListener('targetFound', () => {
          console.log("targetFound");
          guide.style.display = 'none';
          scanning.style.display = 'none';
        });

        this.el.addEventListener('targetLost', () => {
          console.log("targetLost");
          guide.style.display = 'block';
          scanning.style.display = 'block';
        });
      }
    });
  </script>
</head>

<body>
  <!-- СТАРТОВЫЙ ЭКРАН (пока нет разрешения камеры) -->
  <div id="start-screen">
    <div id="start-title">Загрузка…</div>
    <div id="start-subtitle">
      Нажмите кнопку ниже, чтобы разрешить доступ к камере.
      После этого появится подсказка-оверлей для наведения на экспонат.
    </div>
    <div id="spinner"></div>
    <div id="status"></div>
    <button id="start-btn" class="btn">Включить камеру</button>
  </div>

  <!-- ТВОИ ОВЕРЛЕИ (покажем только после старта AR) -->
  <div id="scanning-overlay">Наведите на метку</div>
  <img id="guide-overlay" src="./mamont.jpg" />

  <a-scene
    mindar-image="
      imageTargetSrc: ./mamont.mind;
      autoStart: false;
      uiLoading: no;
      uiScanning: no;
    "
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true;"
  >
    <a-assets>
      <a-asset-item id="model" src="./mamont.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" marker-handler>
      <a-gltf-model
        src="#model"
        position="0 0 0"
        scale="0.01 0.01 0.01"
        rotation="0 -90 0"
        animation-mixer="clip: GltfAnimation 0; loop: repeat"
      ></a-gltf-model>
    </a-entity>
  </a-scene>

  <script>
    window.addEventListener("error", (e) => console.log("window.error:", e.message));
    window.addEventListener("unhandledrejection", (e) => console.log("promise:", e.reason));

    document.addEventListener("DOMContentLoaded", () => {
      const scene = document.querySelector("a-scene");

      const startScreen = document.querySelector("#start-screen");
      const startBtn = document.querySelector("#start-btn");
      const spinner = document.querySelector("#spinner");
      const status = document.querySelector("#status");

      const guide = document.querySelector("#guide-overlay");
      const scanning = document.querySelector("#scanning-overlay");

      const setStatus = (t) => { status.textContent = t || ""; };

      // Когда AR реально готов (камера уже выдана и трекинг поднялся)
      scene.addEventListener("arReady", () => {
        console.log("MindAR ready");
        startScreen.style.display = "none";
        guide.style.display = "block";
        scanning.style.display = "block";
      });

      scene.addEventListener("arError", (e) => {
        console.log("MindAR error", e.detail);
        spinner.style.display = "none";
        startBtn.disabled = false;
        setStatus("Не удалось запустить камеру/AR. Проверьте разрешения и HTTPS.");
      });

      startBtn.addEventListener("click", async () => {
        try {
          startBtn.disabled = true;
          spinner.style.display = "block";
          setStatus("Запрашиваем доступ к камере…");

          // Запуск MindAR по клику (важно для iOS)
          const mindar = scene.systems["mindar-image-system"];
          if (!mindar) throw new Error("mindar-image-system not found");
          await mindar.start();

          // arReady придёт сам и переключит UI
          setStatus("Инициализация AR…");
        } catch (err) {
          console.log("start error:", err);
          spinner.style.display = "none";
          startBtn.disabled = false;
          setStatus("Доступ к камере не получен. Разрешите камеру в настройках браузера.");
        }
      });
    });
  </script>
</body>
</html>
